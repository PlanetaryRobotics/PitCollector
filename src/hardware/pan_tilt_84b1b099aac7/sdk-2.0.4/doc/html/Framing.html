<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Pan-Tilt SDK: Framing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="FLIR-MCS-Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Pan-Tilt SDK</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Framing </div>  </div>
</div>
<div class="contents">
<div class="textblock"><p>The new binary protocol for E-series devices is framed for reliability. It provides fast synchronization and allows rejection of common transmission errors.</p>
<p>There are six components to the frame:</p>
<ul>
<li>Start-of-Frame Marker </li>
<li>Length </li>
<li>Echo Field </li>
<li>Payload (direction dependent fields) </li>
<li>Cyclic Redundancy Check </li>
<li>End-of-Frame Marker</li>
</ul>
<p>Command frame: </p>
<table class="doxtable">
<tr>
<td>SOF<br/>
1 byte </td><td>Length<br/>
1 byte </td><td>Echo<br/>
1 byte </td><td>Opcode<br/>
2 bytes </td><td>Arguments<br/>
0+ bytes </td><td>CRC<br/>
2 bytes </td><td>EOF<br/>
1 byte  </td></tr>
</table>
<p>Reply frame: </p>
<table class="doxtable">
<tr>
<td>SOF<br/>
1 byte </td><td>Length<br/>
1 byte </td><td>Echo<br/>
1 byte </td><td>Status<br/>
2 bytes </td><td>Returns<br/>
0+ bytes </td><td>CRC<br/>
2 bytes </td><td>EOF<br/>
1 byte  </td></tr>
</table>
<h2><a class="anchor" id="encoding"></a>
Frame Encoding</h2>
<p>The frame echo field, payload, and CRC are encoded with Consistent Overhead Byte Stuffing (<a href="http://conferences.sigcomm.org/sigcomm/1997/papers/p062.pdf">http://conferences.sigcomm.org/sigcomm/1997/papers/p062.pdf</a>). This is a byte-stuffing technique which has a well defined overhead and guarantees a specific byte will not appear in the encoded data.</p>
<p>Cheshire and Baker's COBS paper defines ASCII NUL (0x00) as the illegal byte. This implementation is slightly modified to use the ASCII SPACE character (0x20) instead.</p>
<p>Refer to <a class="el" href="cfrm_8c.html">cfrm.c</a> for details on the SDK's COBS variant.</p>
<h2><a class="anchor" id="SOF"></a>
Start-of-Frame Marker</h2>
<p>The SOF marker is a single byte that marks the start of a new frame. This marker gives a receiver positive reinforcement that a new frame has arrived.</p>
<p>SOF is defined as 0xFA. This byte was chosen because it is not a defined D-generation binary opcode.</p>
<h2><a class="anchor" id="length"></a>
Length</h2>
<p>The length field is 8 bits. It is the length of the data in the payload (echo, opcode or status, arguments or returns, and CRC) plus the hexadecimal value 0x21. The length value does not include the SOF, length, or EOF fields.</p>
<h2><a class="anchor" id="echo"></a>
Echo Field</h2>
<p>The echo field is 8 bits of data that is received by the PTU and echoed back in the PTU's reply. This field also contains sequencing bits in the reply. Only the lower four bits are echoed by the PTU. The upper four bits is an incrementing sequence number from the PTU.</p>
<h2><a class="anchor" id="payload"></a>
Payload</h2>
<p>The frame payload layout changes depending on the direction; that is, a command to the PTU is different from a reply from the PTU.</p>
<h3><a class="anchor" id="opcode"></a>
Opcode</h3>
<p>Command frames contain a code that tells the PTU what operation to execute. It is 16 bits wide. See <a class="el" href="openum_8h.html#a0f71a513a62eb693ef9a5bfb23b27b12">cpi_opcode</a> and <a class="el" href="opxref.html">the opcode cross-reference</a> for details.</p>
<h3><a class="anchor" id="status"></a>
Status</h3>
<p>Reply frames contain a status code. This code is a bit-vector of flags for the frame. For example, if the error bit is set, then the return value is to be decoded as a error code instead of the opcode's prescribed return value format.</p>
<h3><a class="anchor" id="enc_args_rets"></a>
Argument and Return Values</h3>
<p>Command frames may contain arguments after the opcode and reply frames may contain returns. Arguments and returns are encoded as signed or unsigned integers, floating-point doubles, and strings. Enumerated types are encoded as integers. ASCII strings and binary strings are encoded identically as a length encoded string.</p>
<p>Integers are 32 bits wide, big-endian, and in twos-complement form.</p>
<p>Doubles are big-endian, normalized, IEEE 754 floating point numbers. Every opcode expects or generates a real number. As such, NaN, infinity, and other floating representations result in undefined behavior.</p>
<p>Strings are length encoded. The first 16 bits are a big-endian unsigned integer of the string length. The follow bytes is the string data.</p>
<h2><a class="anchor" id="CRC"></a>
Cyclic Redundancy Check</h2>
<p>A CRC is used to to protect the frame's data. See <a class="el" href="crc__cfrm_8c.html#a13e845a6cdf9822f7d3b233b81f8fbdb">crc_cfrm</a> for details.</p>
<h2><a class="anchor" id="EOF"></a>
End-of-Frame Marker</h2>
<p>An EOF marker is used to mark the end of a frame. This marker is defined as the COBS illegal byte (0x20) which, when received, forces a restart of a COBS stream decoder. 0x20 also forces a restart of the ASCII protocol's decoder, allowing both the ASCII and binary parsers to coexist. </p>
</div></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Mon Mar 3 2014 12:10:20 for Pan-Tilt SDK by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
